!(function(n,e){"function"==typeof define&&define.amd?define(["sysend"],e):"object"==typeof exports?module.exports=e():n.sysend=e();}("undefined"!=typeof window?window:this,(function(){var n,e,t,r,o,i=400,a="___sysend___",c=new RegExp(a),u=Math.random(),s={},f={},d=[],m=0,l=!1,p=!0,y=!1,h=0,_=0,w=(t=(new Date).getTime(),r=performance&&performance.now&&1e3*performance.now()||0,"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(n){var e=16*Math.random();return t>0?(e=(t+e)%16|0,t=Math.floor(t/16)):(e=(r+e)%16|0,r=Math.floor(r/16)),("x"===n?e:3&e|8).toString(16);}))),g=1,v=0,x={primary:[],close:[],open:[],secondary:[],message:[],visbility:[],ready:[],update:[]},b=Object.keys(x),E=U(s,"to"),k=U(s,"from"),S={id:w,broadcast:function(n,t){return e&&!y?e.postMessage({name:n,data:E(t)}):(!(function(n,e){0==h&&localStorage.setItem(T(n),u);localStorage.setItem(a+n,e);}(n,(function(n){var e=[h++,u];void 0!==n&&e.push(n);var t=E(e);if(t===e)return JSON.stringify(e);return t;}(t)))),setTimeout((function(){var e;e=n,localStorage.removeItem(a+e);}),0)),(function(n,e){d.forEach((function(t){var r={name:a,key:n,data:e};R(j(t.node.src))&&t.window.postMessage(JSON.stringify(r),"*");}));}(n,t)),S;},emit:function(n,e){return S.broadcast(n,e),B(n,e),S;},serializer:function(n,e){if("function"!=typeof n||"function"!=typeof e)throw new Error("sysend::serializer: Invalid argument, expecting function");return s.to=n,s.from=e,S;},proxy:function(...n){return n.forEach((function(n){if("string"==typeof n&&L(n)!==window.location.host){(o=o||[]).push(j(n));const e=document.createElement("iframe");e.style.width=e.style.height=0,e.style.position="absolute",e.style.top=e.style.left="-9999px",e.style.border="none";let t=n;n.match(/\.html|\.php|\?/)||(t=n.replace(/\/$/,"")+"/proxy.html"),e.addEventListener("error",(function t(){setTimeout((function(){throw new Error("html proxy file not found on \""+n+"\" url");}),0),e.removeEventListener("error",t);})),e.addEventListener("load",(function n(){let t;try{t=e.contentWindow;}catch(n){t=e.contentWindow;}d.push({window:t,node:e}),e.removeEventListener("load",n);})),document.body.appendChild(e),e.src=t;}})),!arguments.length&&z&&(l=!0),S;},on:function(n,e){return f[n]||(f[n]=[]),f[n].push(e),S;},off:function(n,e,t=!1){if(f[n])if(e)for(var r=f[n].length;r--;)f[n][r]==e&&f[n].splice(r,1);else(t&&N(n)||!t)&&(f[n]=[]);return S;},track:function(n,e,t=!1){return t&&(e[Symbol.for(a)]=!0),b.includes(n)&&x[n].push(e),S;},untrack:function(n,e,t=!1){return b.includes(n)&&x[n].length&&(x[n]=void 0===e?t?[]:x[n].filter((n=>!n[Symbol.for(a)])):x[n].filter((function(n){return n!==e;}))),S;},post:function(n,e){return S.broadcast(T("__message__"),{target:n,data:e,origin:w});},list:function(){const n=_++,e={target:w,id:n},t=P(S.timeout);return new Promise((function(r){const o=[];S.on(T("__window_ack__"),(function(e){e.origin.target===w&&e.origin.id===n&&o.push({id:e.id,primary:e.primary});})),S.broadcast(T("__window__"),{id:e}),t().then((function(){r(o);}));}));},channel:function(...n){return o=n.map(j),S;},isPrimary:function(){return p;},useLocalStorage:function(n){y="boolean"!=typeof n||n;},rpc:function(n){const e=++v,t=`__${e}_rpc_request__`,r=`__${e}_rpc_response__`;let o=0;S.track("message",(async function({data:e,origin:o}){if(e.type==t){const{method:t,args:i,id:a}=e,c=r;if(Object.hasOwn(n,t))try{!(function(n,e,t=null){if(O(n)){const r=n.then(e);return null===t?r:r.catch(t);}e(n);}(n[t](...i),(function(n){S.post(o,{result:n,id:a,type:c});}),(function(n){S.post(o,{error:n.message,id:a,type:c});})));}catch(n){S.post(o,{error:n.message,id:a,type:c});}else S.post(o,{error:"Method not found",id:a,type:c});}}),!0);return Object.fromEntries(Object.keys(n).map((n=>[n,(e,...i)=>e?(function(n,e,i=[]){const a=++o;return new Promise(((o,c)=>{S.track("message",(function e({data:t,origin:i}){if(t.type===r){const{result:r,error:s,id:f}=t;i===n&&a===f&&(s?c(s):o(r),clearTimeout(u),S.untrack("message",e));}}),!0),S.post(n,{method:e,id:a,type:t,args:i});const u=setTimeout((()=>{c(new Error("Timeout error"));}),1e3);}));}(e,n,i)):Promise.reject(new Error("You need to specify the target window/tab"))])));}};Object.defineProperty(S,"timeout",{enumerable:!0,get:function(){return i;},set:function(n){"number"!=typeof n||isNaN(n)||(i=n);}});var L=(function(){if("undefined"!=typeof URL)return function(n){return n?(n=new URL(n)).host:n;};var n=document.createElement("a");return function(e){return e?(n.href=e,n.host):e;};}());function O(n){return n&&"object"==typeof object&&"function"==typeof object.then;}function P(n){return function(){return new Promise((function(e){setTimeout(e,n);}));};}var j=(function(){function n(n){return function(e){try{return n(e);}catch(n){return e;}};}if(window.URL)return n((function(n){return new URL(n).origin;}));var e=document.createElement("a");return n((function(n){return e.href=n,e.origin;}));}()),I=[];function M(n){I.includes(n)||(I.push(n),console&&console.warn?console.warn(n):setTimeout((function(){throw new Error(n);}),0));}function T(n){return a+n;}function N(n){return n.match(c);}function R(n){if(!o)return M("Call sysend.channel() on iframe to restrict domains that can use sysend channel"),!0;var e=o.includes(n);return e||M(n+" domain is not on the list of allowed domains use sysend.channel() on iframe to allow access to this domain"),e;}function J(n,...e){n.forEach((function(n){n.apply(null,e);}));}function U(n,e){var t={from:"Unserialize",to:"Serialize"}[e]+" Error: ";return function(r){var o=n[e];try{return o?o(r):r;}catch(n){M(t+n.message);}};}var z=(function(){try{return window.self!==window.top;}catch(n){return!0;}}()),C=(function(){try{return localStorage.setItem(a,1),localStorage.removeItem(a),!1;}catch(n){return!0;}}());function H(){return z&&l;}function B(n,e){f[n].forEach((function(t){t(e,n);}));}function $(){p=!0,J(x.primary),S.emit(T("__primary__"));}function q(){var n=new RegExp("^"+a);for(var e in localStorage)e.match(n)&&localStorage.removeItem(e);window.addEventListener("storage",(function(e){if(e.key&&e.key.match(n)&&m++%2==0){var t=e.key.replace(n,"");if(f[t]){var r=e.newValue||(function(n){return localStorage.getItem(T(n));}(t));if(r&&r!=u){var o=(a=k(i=r))===i?JSON.parse(i):a;o&&o[1]!=u&&B(t,o[2]);}}}var i,a;}),!1);}function A(){var t,r;"function"==typeof window.BroadcastChannel?(e=new window.BroadcastChannel(a)).addEventListener("message",(function(n){if(n.target.name===a)if(H()){var e={name:a,data:n.data,iframe_id:w};R(j(document.referrer))&&window.parent.postMessage(JSON.stringify(e),"*");}else{var t=n.data&&n.data.name;f[t]&&B(t,k(n.data.data));}})):C&&M("Your browser don't support localStorgage. In Safari this is most of the time because of \"Private Browsing Mode\""),C||q(),H()?window.addEventListener("message",(function(n){if((function(n){return"string"==typeof n.data&&N(n.data);}(n))&&R(n.origin))try{var e=JSON.parse(n.data);if(e&&e.name===a){var t=k(e.data);S.broadcast(e.key,t);}}catch(n){}})):(void 0!==document.hidden?(t="hidden",r="visibilitychange"):void 0!==document.msHidden?(t="msHidden",r="msvisibilitychange"):void 0!==document.webkitHidden&&(t="webkitHidden",r="webkitvisibilitychange"),"function"==typeof document.addEventListener&&t&&document.addEventListener(r,(function(){J(x.visbility,!document[t]);}),!1),S.track("visbility",(function(e){e&&!n&&$();}),!0),S.on(T("__primary__"),(function(){n=!0;})),S.on(T("__open__"),(function(n){var e=n.id;g++,p&&S.broadcast(T("__ack__")),J(x.open,{count:g,primary:n.primary,id:n.id}),e===w&&J(x.ready);})),S.on(T("__ack__"),(function(){p||J(x.secondary);})),S.on(T("__close__"),(function(e){var t=1===--g;e.wasPrimary&&!p&&(n=!1);var r={id:e.id,count:g,primary:e.wasPrimary,self:e.id===w};t&&$(),J(x.close,r);})),S.on(T("__window__"),(function(n){S.broadcast(T("__window_ack__"),{id:w,origin:n.id,primary:p});})),S.on(T("__message__"),(function(n){("primary"===n.target&&p||n.target===w)&&J(x.message,n);})),addEventListener("beforeunload",(function(){S.emit(T("__close__"),{id:w,wasPrimary:p});}),{capture:!0}),(function(){var n=Array.from(document.querySelectorAll("iframe"));return Promise.all(n.filter((function(n){return n.src;})).map((function(n){return new Promise((function(e,t){n.addEventListener("load",e,!0),n.addEventListener("error",t,!0);}));}))).then(P(S.timeout));}()).then((function(){S.list().then((function(e){g=e.length,p=0===e.length,(e.find((function(n){return n.primary;}))||p)&&(n=!0),S.emit(T("__open__"),{id:w,primary:p}),p&&J(x.primary);}));})));}return-1!==["interactive","complete"].indexOf(document.readyState)?A():window.addEventListener("load",(function(){setTimeout(A,0);})),(function(){let n=[];function e(){J(x.update,n);}S.track("open",(t=>{t.id!==S.id&&(n.push(t),e());}),!0),S.track("close",(t=>{n=n.filter((n=>t.id!==n.id)),e();}),!0),S.track("ready",(()=>{S.list().then((t=>{n=t,e();}));}),!0);}()),S;})));
