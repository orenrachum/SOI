function w(I,e,t,i,a,n,r){try{var l=I[n](r),s=l.value}catch(d){t(d);return}l.done?e(s):Promise.resolve(s).then(i,a)}function g(I){return function(){var e=this,t=arguments;return new Promise(function(i,a){var n=I.apply(e,t);function r(s){w(n,i,a,r,l,"next",s)}function l(s){w(n,i,a,r,l,"throw",s)}r(void 0)})}}class c{init(){var e=this;return g(function*(){yield e.loadDebugger(),e.setCanvas()&&(e.handleInstances(),e.setup(),e.loadFirstFrame())})()}loadDebugger(){var e=this;return g(function*(){let{isDebug:t,id:i}=e;if(t){let{default:a}=yield import("./ImageSequenceDebug.js");e.log=(...n)=>{a({id:i},...n)}}else e.log=()=>{}})()}setCanvas(){let{canvasSelector:e,id:t}=this;if(!(e&&typeof e=="string"))return this.log(1),!1;let a=document.querySelector(e);if(!a)return;if(a&&a.nodeName==="CANVAS"&&a.getContext)return a.dataset.sequenceId=t,this.canvas=a,!0;if(a&&a.nodeName.toLowerCase()==="mp-sequence"){let l=a.querySelector("canvas");return a.dataset.sequenceId=t,this.canvas=l,!0}return this.log(2),!1}setup(){let{smallImagesRoot:e,mediumImagesRoot:t,canvas:i,isBuilder:a,largeImagesRoot:n,imgBreakpoints:r,ext:l,frames:s,imageFit:d}=this;if(!i)return!1;innerWidth<r.small&&e?this.basePath=e:innerWidth<r.medium&&t?this.basePath=t:this.basePath=n;let h=["png","webp"].includes(l)||d===1;this.maxIndex=this.totalFrames,this.hasFramesEnabled=Array.isArray(s)&&s?.length===2,this.frames||(this.frames=[1,this.maxIndex]),this.totalFrames=this.hasFramesEnabled?s[1]-s[0]+1:this.totalFrames,this.ctx=i.getContext("2d",{alpha:h}),this.handleResize(),this.resizeController=new AbortController,window.addEventListener("resize",()=>this.handleResize(),{signal:this.resizeController.signal}),a&&Array.isArray(c.resizeControllers)&&c.resizeControllers.push(this.resizeController)}loadFirstFrame(){let e=performance.now(),{basePath:t,numPadding:i,ext:a,hasFramesEnabled:n,isReverse:r,totalFrames:l,frames:s,canvasIndex:d,isIntersectionObserver:h}=this,o=new Image,u=n?s[0]:1,m=n?s[1]:l,v=r?m:u,f=i?String(v).padStart(i,String(0)):String(v),p=`${t}${f}.${a}`,b=()=>{typeof v=="number"&&(this.images[v]=o,d===1&&this.renderIndex(v,!1))};o.onerror=()=>this.log(3),o.onload=()=>{let x=performance.now()-e,{enableFallback:F,potentialReasons:C}=this.checkFallback(x);if(F){this.handleFallback(o,C);return}b(),this.loadImages()},o.src=p,o.decoding=h?"async":"sync"}loadImage(e){return new Promise(t=>{let{basePath:i,numPadding:a,hasFramesEnabled:n,ext:r,frames:l,isIntersectionObserver:s}=this,d=n?l[0]-1:0,h=a?String(d+e).padStart(a,String(0)):e,o=`${i}${h}.${r}`,u=new Image;u.onerror=()=>{this.images[e-1]=null,t(1)},u.onload=()=>{this.images[e-1]=u,t(1)},u.src=o,u.decoding=s?"async":"sync"})}loadPriorityQueue(e,t){var i=this;return g(function*(){for(let n of e)yield i.loadImage(n);let a=((performance.now()-t)/1e3).toFixed(3);i.log(8,e?.length,a)})()}loadQueue(e){let t=performance.now();for(let a of e)this.loadImage(a);let i=((performance.now()-t)/1e3).toFixed(3);this.log(9,e?.length,i)}createQueue(){let{totalFrames:e,skipFrames:t}=this,i=Array(e).fill(0).map((l,s)=>s+1);t&&(i=i.filter((l,s)=>s%t!=0));let a=i.slice(0,Math.floor(.25*i.length)),n=a.map((l,s)=>{let d=Math.floor(s/a.length*e);return i.reduce((h,o)=>Math.abs(o-d)<Math.abs(h-d)?o:h)}),r=i.filter(l=>!n.includes(l));return r?.length&&!n?.length&&(n=r,r=[]),{priorityQueue:n,queue:r}}loadImages(){var e=this;return g(function*(){let{totalFrames:t,isIntersectionObserver:i,isBuilder:a,maxIndex:n,frames:r}=e,l=t===void 0||t===0||t<=n,s=r[1]<r[0];if(!l||s){e.log(7);return}let{priorityQueue:d,queue:h}=e.createQueue(),o=performance.now();if(e.images=Array(t).fill(null),yield e.loadPriorityQueue(d,o),h?.length){let u="IntersectionObserver"in window,m=i&&u&&!a;m||e.loadQueue(h),m&&e.handleIntersectionObserver(()=>e.loadQueue(h))}})()}handleIntersectionObserver(e){let{intersectionObserverMargin:t,canvas:i}=this,a=`${t??String(0)}%`,n=new IntersectionObserver(r=>{let{isIntersecting:l}=r[0];l&&(n.disconnect(),e())},{rootMargin:a});if(i)n.observe(i);else throw Error("Canvas not found")}handleResize(){let{canvas:e,currentIndex:t,id:i,canvasIndex:a}=this;if(!(e&&e instanceof HTMLCanvasElement))return!1;if(a===1){var r,l,s,d;let u=((l=(r=window)==null?void 0:r.devicePixelRatio)!=null?l:1)*1.25,m=(s=e.offsetWidth)!=null?s:e.width,v=(d=e.offsetHeight)!=null?d:e.height;e.width=m*u,e.height=v*u}i===this.currentNode&&!Number.isNaN(t)&&this.renderIndex(t,!0)}replaceCanvasWithImage(e){if(!e)return;let{imageFit:t,canvas:i}=this;if(i&&e){var a;e.style.objectFit={0:"cover",1:"contain",2:"fill"}[t],i==null||(a=i.parentNode)==null||a.replaceChild(e,i)}}handleFallback(e,t){var i,a,n,r,l,s,d,h;let{fallbackMode:o}=this,u=this.timelineUID&&this.timelineUID in window&&((a=window)==null||(i=a[this.timelineUID])==null?void 0:i.revert);if(o===0||o>=2&&o<=4)switch(o){case 0:this.replaceCanvasWithImage(e);break;case 1:case 3:break;case 2:this==null||(r=this.canvas)==null||r.remove();break;case 4:{let m=(h=(d=(s=this.totalFrames)!=null?s:(l=this.frames)==null?void 0:l[1])!=null?d:this.maxIndex)!=null?h:1;this.replaceCanvasWithImage(this.images[m])}}o!==1&&this.resizeController&&this.resizeController.abort(),u&&((n=window)==null||n[this.timelineUID].revert()),this.preventUpdate=!0,this.log(6,o,t.indexOf(!0),u)}checkFallback(e){let{mediaQuery:t,isBuilder:i,whenDisabled:a}=this,n=a.includes("SLOW_CONNECTION"),r=!!n&&this.checkConnection(e),l=!window.matchMedia(t).matches,s=this.checkDevice(),d=[r,l,s];return{enableFallback:!i&&d.some(Boolean),potentialReasons:d}}checkDevice(){let{whenDisabled:e}=this,t=navigator.userAgent.toLowerCase(),i={CHROME:()=>t.includes("chrome")&&"chrome"in window&&!t.includes("edg"),SAFARI:()=>/^((?!chrome|android).)*safari/i.test(t),FIREFOX:()=>t.includes("firefox"),EDGE:()=>t.includes("chrome")&&t.includes("edg"),IE:()=>/msie|trident/.test(t),TOUCH:()=>"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,MOBILE:()=>/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(t),PC:()=>!/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(t),MOBILE_SAFARI:()=>/iphone|ipad|ipod/i.test(t)&&/^((?!chrome|android).)*safari/i.test(t)};return e?.some(a=>{var n;return i==null||(n=i[a])==null?void 0:n.call(i)})}checkConnection(e){let t=navigator.connection;return t?.downlink&&t.downlink<1.2||e>600}renderIndex(e,t){var i;let{currentIndex:a,images:n}=this;if(!(!(!t&&e===a)||n))return!1;if((i=n[e])==null?void 0:i.complete){this.drawImage(e);return}this.renderClosestIndex(e)}renderClosestIndex(e){var t,i,a,n;let{images:r,skipFrames:l}=this,s=Number.MAX_SAFE_INTEGER,d=e;for(;d>=0;d--)if((a=r[d])!=null&&a.complete){s=d;break}let h=Number.MAX_SAFE_INTEGER,o=e;for(;o<r.length;o++)if((n=r[o])!=null&&n.complete){h=o;break}(t=r[s])!=null&&t.complete?(this.drawImage(s),l||this.log(4,e,s)):(i=r[h])!=null&&i.complete&&(this.drawImage(h),l||this.log(4,e,h))}drawImage(e){var t;let{imageFit:i,ctx:a,canvas:n,images:r,isBuilder:l,ext:s}=this;if(!(n&&a))return this.log(5),!1;let{width:d,height:h}=n,o=r[e];if(!(o?.complete&&o.width&&o.height))return!1;(l||["png","webp"].includes(s)||i===1)&&a.clearRect(0,0,d,h),this.currentIndex=e,this._currentNode=(t=this.id)!=null?t:"",i===0?this.drawImageCover(o):i===1?this.drawImageContain(o):a.drawImage(o,0,0,d,h)}drawImageContain(e){let{canvas:t,ctx:i}=this;if(!(t&&i))return!1;let a=Math.min(t.width/e.width,t.height/e.height),n=t.width/2-e.width/2*a,r=t.height/2-e.height/2*a,l=e.width*a,s=e.height*a;i.drawImage(e,n,r,l,s)}drawImageCover(e){let t,i,{ctx:a,canvas:n}=this,{width:r,height:l}=e;if(!(n&&a))return!1;let s=n.width,d=n.height,h=r/l,o=s/d;h>o?(t=d,i=d*h):(i=s,t=s/h);let u=(s-i)*.5,m=(d-t)*.5;a.drawImage(e,u,m,i,t)}handleUpdate(e){let{isReverse:t,totalFrames:i,preventUpdate:a}=this;if(a)return;let n=Math.floor((t?1-e:e)*(i-1));window.requestAnimationFrame(()=>this.renderIndex(n,!1))}handleInstances(){var e;let{canvasSelector:t,isBuilder:i,id:a}=this,n=c==null||(e=c.canvasInstances)==null?void 0:e[t];n&&c.canvasInstances[t].index++,t&&(n||(c.canvasInstances[t]={index:1,currentNode:a}),this.canvasIndex=c.canvasInstances[t].index),i&&!c?.reset&&(c.reset=()=>{let{resizeControllers:l}=c;l&&(l.forEach(s=>s?.abort()),c.resizeControllers=[]),c.canvasInstances={}})}set currentNode(e){c?.canvasInstances[this==null?void 0:this.canvasSelector]&&(c.canvasInstances[this.canvasSelector].currentNode=e)}get currentNode(){var e,t;return(t=(e=c.canvasInstances[this.canvasSelector])==null?void 0:e.currentNode)!=null?t:this._currentNode}constructor(e){var t,i;this._currentNode="",this.reset=()=>{},this.log=(...a)=>{},this.resizeController=null,this.isDebug=!1,this.id=void 0,this.canvasSelector="",this.canvas=null,this.maxIndex=void 0,this.totalFrames=void 0,this.smallImagesRoot=void 0,this.mediumImagesRoot=void 0,this.largeImagesRoot=void 0,this.imgBreakpoints={small:768,medium:1024},this.frames=void 0,this.numPadding=4,this.imageFit=0,this.hasFramesEnabled=void 0,this.ctx=null,this.images=[],this.skipFrames=0,this.isIntersectionObserver=!1,this.isReverse=!1,this.intersectionObserverMargin=0,this.fallbackMode=0,this.whenDisabled=[],this.ext="jpg",this.mediaQuery="screen",this.timelineUID="",this.isRevertOnFallback=void 0,this.isBuilder=!!(!((i=window)==null||(t=i.top)==null)&&t.motionpage),this.canvasIndex=0,this.currentIndex=0,this.basePath="",this.preventUpdate=!1,Object.keys(e).forEach(a=>{a in this&&(this[a]=e[a])}),this.init()}}c.canvasInstances={},c.resizeControllers=[],c.reset=()=>{},window._mp_ImageSequence=c,window.MOTIONPAGE_FRONT.imageSequence=c;export{c as default};
